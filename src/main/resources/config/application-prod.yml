# ===================================================================
# Spring Boot configuration.
#
# This configuration will be overridden by the Spring profile you use
# For example: application-dev.yml if you use the "dev" profile.
# ===================================================================

# ===================================================================
# Standard Spring Boot properties.
# Full reference is available at:
# https://docs.spring.io/spring-boot/reference/features/profiles.html
# ===================================================================
spring.config.import: optional:configserver:http://ars-config-server:8888

logging:
  level:
    root: info
    com.ars.gateway: info
  charset:
    console: UTF-8
    file: UTF-8
  file:
    path: /app/logs/gateway

server:
  port: 8080

spring:
  cloud:
    config:
      uri: http://ars-config-server:8888
    gateway:
      # The parameters below are relatively dependent on each other
      # Consider before changing because one parameter will affect the remaining parameters
      httpclient:
        # Maximum time (in milliseconds) Gateway waits to open a TCP connection to downstream services
        # This only counts the TCP handshake phase, not the API response time
        connect-timeout: 10000
        # Maximum time Gateway waits for response from downstream services after request has been sent successfully
        # If downstream services does not respond within this time → Gateway disconnects, returns error 504 GATEWAY_TIMEOUT
        response-timeout: 10s
        pool:
          # Maximum number of TCP connections the Gateway can hold open simultaneously to downstream services
          # Reactor Netty uses a connection pool (reuses keep-alive connections) to avoid the overhead of opening new connections
          # This is the total number of connections per host (in Reactor Netty)
          # If the Gateway calls multiple backends, each backend has its own pool
          # Based on the maximum number of requests that an instance can handle concurrently
          # (In Tomcat/Spring Boot servlet-based, corresponding to the parameters default: maxThreads = 200)
          max-connections: 200
          # When all connections in the pool are busy, the new request will wait up to 5 seconds to borrow a free connection
          # If this time is over and there is no connection → Gateway reports an error
          # With traffic of about 2,000 requests/s per backend instance and average latency of ~500ms,
          # acquire-timeout = 5s ensures that requests wait for a free connection in the pool for up to 5s
          # before failing, enough for most requests to be processed without disconnection or error
          acquire-timeout: 5

      # Global request filters
      default-filters:
        - name: AddRequestHeader
          args:
            name: X-API-Version
            value: v1
        - name: AddResponseHeader
          args:
            name: Cache-Control
            value: public, max-age=300

      # Route configurations
      routes:
        - id: chat-service-websocket-route
          uri: lb:ws://CHAT-SERVICE
          predicates:
            - Path=/ws/**

        - id: user-service-route
          uri: lb://USER-SERVICE
          predicates:
            - Path=/api/v1/users/**, /api/p/v1/users/**, /login/**
          filters:
            - RemoveRequestHeader=Cookie
            - RemoveRequestHeader=Set-Cookie
            - name: CustomRateLimiter
              args:
                rate-limiter.banThreshold: 10
                rate-limiter.windowSeconds: 1
                rate-limiter.banDurationMinutes: 10

        - id: admin-service-route
          uri: lb://ADMIN-SERVICE
          predicates:
            - Path=/api/v1/admin/**
          filters:
            - RemoveRequestHeader=Cookie
            - RemoveRequestHeader=Set-Cookie
            - name: CustomRateLimiter
              args:
                rate-limiter.banThreshold: 10
                rate-limiter.windowSeconds: 1
                rate-limiter.banDurationMinutes: 10

      # Load balancer configuration
      loadbalancer:
        use404: true

      # Metrics configuration
      metrics:
        enabled: true
        tags:
          path:
            enabled: true
          application: ${spring.application.name}
          environment: ${spring.profiles.active}
      observability:
        enabled: true
  # Redis Configuration for Rate Limiting
  data:
    redis:
      host: ars-redis
      port: 6379
      password: ${ARS_REDIS_PASSWORD}
      database: 1
      timeout: 100ms
      connect-timeout: 500ms
      lettuce:
        pool:
          enabled: true
          max-active: 5
          max-idle: 3
          min-idle: 2
          max-wait: 1s
          time-between-eviction-runs: 20s
        shutdown-timeout: 1s
      ssl:
        enabled: false

# Eureka client configuration
eureka:
  client:
    service-url:
      defaultZone: http://ars-discovery-server:8761/eureka/
    healthcheck:
      enabled: true
    register-with-eureka: true
    fetch-registry: true
  instance:
    prefer-ip-address: true
    hostname: ars-gateway
    instanceId: ${spring.application.name}:${server.port}

app:
  device-key: ${DEVICE_KEY} # 32 characters
  security:
    rate-limit-excluded-apis:
      - /favicon.ico
    public-request-patterns:
      - /favicon.ico
      - /api/p/**
      - /login/**
      - /ws/**
    jwt:
      access-token:
        base64-secret-key: ${ARS_GATEWAY_SECURITY_KEY}
  i18n:
    base-names:
      - classpath:i18n/messages
      - classpath:i18n/base_messages
    encoding: UTF-8
  cors:
    activate: enabled
    patterns:
      '[/**]':
        allowed-origin-patterns:
          - "*"
        allowedMethods:
          - GET
          - POST
          - PUT
          - PATCH
          - DELETE
          - OPTIONS
        allowedHeaders:
          - Content-Type
          - Authorization
          - Accept
          - Origin
          - Access-Control-Allow-Origin
          - X-CSRF-Token
          - X-Device-ID
        allowCredentials: true
        maxAge: 3600  # Cache preflight response in 1 hour
